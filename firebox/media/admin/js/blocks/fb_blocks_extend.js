(()=>{"use strict";const e=window.React,t=window.wp.i18n,o=window.wp.hooks,a=window.wp.element,n=window.wp.blocks,l=window.wp.blockEditor,i=window.wp.compose,r=window.wp.components,c=["core/button","core/image","firebox/button","firebox/image"];class d{getBlockWithTrackingEnabled(e){if(!e||!e.length)return;let t=null;return e.forEach((e=>{if(e.attributes&&e.attributes.dataFBoxTrackingEnabled)t=e;else{let o=this.getBlockWithTrackingEnabled(e.innerBlocks);o&&!t&&(t=o)}})),t}hasFireBoxFormBlock(e){return e.some((e=>"firebox/form"===e.name||e.innerBlocks&&this.hasFireBoxFormBlock(e.innerBlocks)))}disableConversionTrackingInBlocks(e){e&&e.length&&e.forEach((e=>{c.includes(e.name)?wp.data.dispatch("core/block-editor").updateBlockAttributes(e.clientId,{dataFBoxTrackingEnabled:!1,dataFBoxTrackingControlDisabled:!0}):this.disableConversionTrackingInBlocks(e.innerBlocks)}))}disableOtherConversionTracking(e,t){t&&t.length&&t.forEach((t=>{t.clientId!==e.clientId&&c.includes(t.name)?wp.data.dispatch("core/block-editor").updateBlockAttributes(t.clientId,{dataFBoxTrackingEnabled:!1,dataFBoxTrackingControlDisabled:!0}):this.disableOtherConversionTracking(e,t.innerBlocks)}))}enableOtherConversionTracking(e){e&&e.length&&e.forEach((e=>{c.includes(e.name)?wp.data.dispatch("core/block-editor").updateBlockAttributes(e.clientId,{dataFBoxTrackingControlDisabled:!1}):this.enableOtherConversionTracking(e.innerBlocks)}))}init(){let e=wp.data.select("core/block-editor").getBlocks();if(e.length&&"firebox"===window.typenow){const t=this.getBlockWithTrackingEnabled(e);if(this.hasFireBoxFormBlock(e))return void this.disableConversionTrackingInBlocks(e);t?this.disableOtherConversionTracking(t,e):(this.maybeEnableSelectedBlock(),this.enableOtherConversionTracking(e))}}maybeEnableSelectedBlock(){const e=wp.data.select("core/block-editor").getSelectedBlock();e&&c.includes(e.name)&&null===e.attributes.dataFBoxTrackingEnabled&&wp.data.dispatch("core/block-editor").updateBlockAttributes(e.clientId,{dataFBoxTrackingEnabled:!0,dataFBoxTrackingControlDisabled:!1})}}let s=wp.data.select("core/editor").getEditedPostContent();wp.data.subscribe(lodash.debounce((()=>{let e=wp.data.select("core/editor").getEditedPostContent();s!==e&&(new d).init(),s=e}),200));let p=[];p.push({value:"none",label:(0,t.__)("Select a Campaign","firebox")}),"firebox"===window.typenow&&p.push({value:"current",label:(0,t.__)("Current Campaign","firebox")}),wp.apiFetch({path:"/firebox/v1/campaigns"}).then((function(e){e.forEach((e=>{e.value!=wp.data.select("core/editor").getCurrentPostId()&&p.push({value:e.value,label:e.label})}))}));const b=(0,i.createHigherOrderComponent)((o=>n=>{const{clientId:i,name:d,attributes:s,setAttributes:b}=n,{url:u,href:m,dataFBoxOnClick:x,dataFBoxOnClickURL:g,dataFBoxOnClickURLAddParameters:C,dataFBoxOnClickCloseCampaign:f,dataFBoxOnClickOpenCampaign:k,dataFBoxOnClickCopyClipboard:h,dataFBoxOnClickDownloadFileURL:_,dataFBoxTrackingEnabled:B,dataFBoxTrackingControlDisabled:w}=s,F=e=>wp.data.select("core/block-editor").getBlockParentsByBlockName(e,"firebox/form").length>0,E=[{label:(0,t.__)("Open URL","firebox"),value:"open_url"},{label:(0,t.__)("Close Campaign","firebox"),value:"close_campaign"},{label:(0,t.__)("Open Campaign","firebox"),value:"open_campaign"},{label:(0,t.__)("Copy to Clipboard","firebox"),value:"copy_clipboard"},{label:(0,t.__)("Download File","firebox"),value:"download_file"},{label:(0,t.__)("Go to Step (Coming Soon)","firebox"),disabled:!0,value:"go_to_step"}],O=(e="")=>{""!==e&&void 0!==e?e!==g&&b({dataFBoxOnClickURL:e}):b({dataFBoxOnClickURL:"",dataFBoxOnClickURLAddParameters:!1})};return(0,a.useEffect)((()=>{["core/image","firebox/image"].includes(d)&&O(m)}),[m]),(0,a.useEffect)((()=>{["core/button","firebox/button"].includes(d)&&O(u)}),[u]),(0,a.useEffect)((()=>{let e=!1;if(c.includes(d)){let t={};if(["core/button","firebox/button"].includes(d)?t.url=g:["core/image","firebox/image"].includes(d)&&(t.href=g),!Object.keys(t).length)return;e=setTimeout((()=>{b(t)}),250)}if(e)return()=>clearTimeout(e)}),[g]),(0,e.createElement)(a.Fragment,null,c.includes(d)&&(0,e.createElement)(l.InspectorControls,null,(0,e.createElement)(r.PanelBody,{title:(0,t.__)("FireBox","firebox"),initialOpen:"firebox/button"!==d||!F(i)},(0,e.createElement)(r.SelectControl,{label:(0,t.__)("On Click","firebox"),value:x,options:E,onChange:e=>b({dataFBoxOnClick:e}),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),"open_url"==x&&(0,e.createElement)(a.Fragment,null,(0,e.createElement)(r.TextControl,{label:(0,t.__)("URL","firebox"),value:g,onChange:e=>{let t={dataFBoxOnClickURL:e};""===e&&["core/button","firebox/button"].includes(d)&&(t.url=""),"core/image"===d?t.href=e:"firebox/image"===d&&(t.href=e,""===e&&(t.link="none")),e||(t.dataFBoxOnClickURLAddParameters=!1),b(t)},help:(0,t.__)(`Enter a URL to redirect to when this ${d.split("/").pop()} is clicked.`,"firebox"),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),""!==g.trim()&&(0,e.createElement)(r.ToggleControl,{label:(0,t.__)("Add UTM Parameters","firebox"),checked:!!C,onChange:()=>b({dataFBoxOnClickURLAddParameters:!C}),help:(0,t.__)("Enable to append UTM parameters to the URL. The UTM parameters are automatically added on the URL and consist of utm_source which is the post type, utm_medium which is the block name, utm_campaign which is the post title and the utm_content which is the block text or image URL.","firebox"),__nextHasNoMarginBottom:!0})),"close_campaign"===x&&(0,e.createElement)(r.SelectControl,{label:(0,t.__)("Close Campaign","firebox"),value:f,options:p,onChange:e=>b({dataFBoxOnClickCloseCampaign:e}),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),"open_campaign"===x&&(0,e.createElement)(a.Fragment,null,p.length>=2?(0,e.createElement)(r.BaseControl,{help:(0,t.__)("Note that the selected campaign must be present on the same page in order to be opened.","firebox")},(0,e.createElement)(r.SelectControl,{label:(0,t.__)("Open Campaign","firebox"),value:k,options:p,onChange:e=>b({dataFBoxOnClickOpenCampaign:e}),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0})):(0,e.createElement)("div",{className:"fpframework-gutenberg-help-text"},(0,t.__)("There are no published campaigns that can be opened. Please publish some campaigns first.","firebox"))),"copy_clipboard"===x&&(0,e.createElement)(r.TextControl,{label:(0,t.__)("Text to copy","firebox"),value:h,onChange:e=>b({dataFBoxOnClickCopyClipboard:e}),help:(0,t.__)("Enter a text to copy to the clipboard when this block is clicked.","firebox"),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),"download_file"===x&&(0,e.createElement)(r.TextControl,{label:(0,t.__)("File URL","firebox"),value:_,onChange:e=>b({dataFBoxOnClickDownloadFileURL:e}),help:(0,t.__)("Enter a URL to a file to download when this block is clicked.","firebox"),__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0}),"firebox"===window.typenow&&!F(i)&&(0,e.createElement)(a.Fragment,null,(0,e.createElement)(r.ToggleControl,{label:(0,t.__)("Track conversion","firebox"),checked:!!B,onChange:()=>b({dataFBoxTrackingEnabled:!B}),help:(0,t.__)(`Enable to track conversions when the ${d.split("/").pop()} is clicked.`,"firebox"),className:w?"fpframework-gutenberg-m-b-5":"",disabled:w,__nextHasNoMarginBottom:!0}),w&&(0,e.createElement)("p",{className:"fpframework-color-red components-base-control"},(0,t.__)("One block per campaign is allowed to track conversions.","firebox"))))),(0,e.createElement)(o,{...n}))}),"FBox_Block_Set_Advanced_Controls");(0,o.addFilter)("blocks.registerBlockType","fbox/fbox-cpt-custom-attributes",(function(e){return c.includes(e.name)?(void 0!==e.attributes&&(e.attributes=Object.assign(e.attributes,{dataFBoxOnClick:{type:"string",default:"open_url"},dataFBoxOnClickURL:{type:"string",default:""},dataFBoxOnClickURLAddParameters:{type:"boolean",default:!1},dataFBoxOnClickCloseCampaign:{type:"string",default:"current"},dataFBoxOnClickOpenCampaign:{type:"string",default:""},dataFBoxOnClickCopyClipboard:{type:"string",default:""},dataFBoxOnClickDownloadFileURL:{type:"string",default:""},dataFBoxTrackingEnabled:{type:"boolean",default:null},dataFBoxTrackingControlDisabled:{type:"boolean",default:!1}})),e):e})),(0,o.addFilter)("editor.BlockEdit","fbox/fbox-cpt-custom-controls",b),(0,o.addFilter)("blocks.getSaveElement","my-plugin/wrap-cover-block-in-container",((e,t,o,a)=>{if(!e)return;if(!c.includes(t.name))return e;const n=e=>e.some((e=>"firebox/form"===e.name||e.innerBlocks&&n(e.innerBlocks))),{dataFBoxTrackingEnabled:l,dataFBoxOnClick:i,dataFBoxOnClickCloseCampaign:r,dataFBoxOnClickOpenCampaign:d,dataFBoxOnClickCopyClipboard:s,dataFBoxOnClickDownloadFileURL:p}=o,b=(e,t)=>{if(!e||"object"!=typeof e)return e;if("a"===e.type||"a"===e.props.tagName){const o={...e.props,href:t,download:"true"};return{...e,props:o}}if(e.props&&e.props.children){const o=React.Children.map(e.props.children,(e=>b(e,t)));return{...e,props:{...e.props,children:o}}}return e};if(n(wp.data.select("core/block-editor").getBlocks())||(l?e=React.cloneElement(e,{"data-fbox-tracking":"true"}):delete e.props["data-fbox-tracking"]),"close_campaign"===i&&"none"!==r){let t={"data-fbox-cmd":"close"};return"current"!==r&&(t["data-fbox"]=r),React.cloneElement(e,t)}if("open_campaign"===i&&"none"!==d){let t={"data-fbox-cmd":"open"};return"current"!==d&&(t["data-fbox"]=d),React.cloneElement(e,t)}if("copy_clipboard"===i&&""!==s){let t={"data-fbox-copy-clipboard":s};return React.cloneElement(e,t)}if("download_file"===i&&""!==p){let t={};return React.cloneElement(b(e,p),t)}return e})),(0,n.updateCategory)("firebox",{icon:()=>(0,e.createElement)(r.SVG,{xmlns:"http://www.w3.org/2000/svg",width:"25",viewBox:"0 0 40 40",style:{marginLeft:"5px"}},(0,e.createElement)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M8.43049 0C3.77446 0 0 3.77446 0 8.43049V31.5695C0 36.2255 3.77446 40 8.43049 40H31.5695C36.2255 40 40 36.2255 40 31.5695V8.43049C40 3.77446 36.2255 0 31.5695 0H8.43049ZM11.1211 9.32735C10.1304 9.32735 9.32735 10.1304 9.32735 11.1211V28.8789C9.32735 29.8696 10.1304 30.6726 11.1211 30.6726H28.8789C29.8696 30.6726 30.6726 29.8696 30.6726 28.8789V11.1211C30.6726 10.1304 29.8696 9.32735 28.8789 9.32735H11.1211ZM16.8966 17.9728C16.8966 17.3785 17.3785 16.8966 17.9728 16.8966H22.0272C22.6215 16.8966 23.1034 17.3785 23.1034 17.9728V22.0272C23.1034 22.6215 22.6215 23.1034 22.0272 23.1034H17.9728C17.3785 23.1034 16.8966 22.6215 16.8966 22.0272V17.9728Z",fill:"#2438E9"}))}),(0,n.updateCategory)("fireplugins",{icon:()=>(0,e.createElement)(r.SVG,{xmlns:"http://www.w3.org/2000/svg",width:"25",viewBox:"0 0 40 40",style:{marginLeft:"5px"}},(0,e.createElement)("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M16.7589 0L20.7524 2.63971C29.0855 8.14791 34.1404 15.9983 33.3678 24.8262C32.5645 34.0043 24.4333 40.737 15.2662 39.9352C6.09897 39.1335 -0.739139 31.0916 0.0641224 21.9136C0.180255 20.5867 0.37899 19.1879 1.12266 17.3053C1.80271 15.5836 2.89509 13.5649 4.59658 10.8145L8.53268 13.2477L8.67938 13.0126C8.7833 12.8461 8.93413 12.6044 9.12162 12.3038C9.49663 11.7027 10.0182 10.8662 10.6046 9.92495C11.7784 8.04091 13.2083 5.74258 14.2418 4.07104L16.7589 0ZM12.4706 15.7359C10.8676 18.3298 10.1297 19.7788 9.76001 20.7147C9.45209 21.4942 9.38344 21.9423 9.31514 22.7227C8.964 26.7348 11.9588 30.3275 16.0755 30.6875C20.1922 31.0476 23.7656 28.0293 24.1168 24.0172C24.413 20.6323 23.0665 16.8868 19.4014 13.3644C19.0872 13.8692 18.7792 14.3639 18.4873 14.8323C17.8998 15.7755 17.3772 16.6135 17.0014 17.2158C16.8136 17.517 16.6624 17.7593 16.5582 17.9263L16.3967 18.185C16.3967 18.185 16.3965 18.1852 12.4706 15.7359Z",fill:"#2438E9"}))})})();